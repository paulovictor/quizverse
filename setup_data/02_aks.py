#!/usr/bin/env python
"""
Script consolidado para setup completo de AK-47 Skins do Counter-Strike.
Cria temas, quizgroup, quizzes e quest√µes em uma √∫nica execu√ß√£o.

Pr√©-requisito: 00_root_themes.py deve ter sido executado.
"""

import os
import sys
import json
import random
import django
from pathlib import Path

# Configura√ß√£o do Django
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'quiz.settings')
django.setup()

from quizzes.models import Theme, Quiz, QuizGroup, Question, Answer, Badge, QuizGroupBadge


# ============================================================================
# FUN√á√ïES AUXILIARES
# ============================================================================

def load_ak47_data():
    """Carrega os dados das AK-47 do arquivo JSON"""
    data_file = Path(project_root) / 'cs2_skins' / 'ak_47.json'

    if not data_file.exists():
        print(f"‚ùå Erro: Arquivo ak_47.json n√£o encontrado em {data_file}")
        return None

    with open(data_file, 'r', encoding='utf-8') as f:
        return json.load(f)


def load_cloudinary_urls():
    """Carrega as URLs do Cloudinary"""
    cloudinary_file = Path(project_root) / 'ak47_urls.json'

    if not cloudinary_file.exists():
        print("‚ö†Ô∏è  Arquivo ak47_urls.json n√£o encontrado")
        print("Ser√° usado o caminho da foto do JSON")
        return None

    with open(cloudinary_file, 'r', encoding='utf-8') as f:
        data = json.load(f)
        # Criar dicion√°rio indexado por nome normalizado
        url_map = {}
        for item in data:
            # Extrair nome do public_id (remover sufixo hash)
            name = item['public_id'].rsplit('_', 1)[0].replace('_', ' ')
            url_map[name] = item['secure_url']
        return url_map


def get_skin_url(skin_name, cloudinary_urls, fallback_url):
    """Retorna a URL da skin do Cloudinary ou fallback"""
    if cloudinary_urls and skin_name in cloudinary_urls:
        return cloudinary_urls[skin_name]
    return fallback_url


# ============================================================================
# ETAPA 0: CRIAR TEMAS COUNTER-STRIKE (PAI)
# ============================================================================

def create_counter_strike_themes():
    """Cria o tema Counter-Strike (pai) para todos os pa√≠ses"""

    print("=" * 80)
    print("ETAPA 0: CRIANDO TEMAS COUNTER-STRIKE (PAI)")
    print("=" * 80)
    print()

    theme_image = 'https://res.cloudinary.com/dwm53cbu2/image/upload/v1760663478/counter-strike-2-pc-jogo-steam-cover_zp57n2.jpg'

    colors = {
        'primary_color': '#ff6347',  # Vermelho CS
        'secondary_color': '#1e90ff',  # Azul CS
        'icon_bg_color_1': '#fff5f0',
        'icon_bg_color_2': '#ffcccb',
    }

    translations = {
        'pt': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Teste seus conhecimentos sobre Counter-Strike! Skins, mapas, armas e muito mais.',
            'parent_slug': 'jogos',
        },
        'en': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Test your Counter-Strike knowledge! Skins, maps, weapons and more.',
            'parent_slug': 'games',
        },
        'es': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': '¬°Pon a prueba tus conocimientos sobre Counter-Strike! Skins, mapas, armas y m√°s.',
            'parent_slug': 'juegos',
        },
        'fr': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Testez vos connaissances sur Counter-Strike! Skins, cartes, armes et plus.',
            'parent_slug': 'jeux',
        },
        'de': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Teste dein Counter-Strike Wissen! Skins, Karten, Waffen und mehr.',
            'parent_slug': 'spiele',
        },
        'it': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Metti alla prova le tue conoscenze su Counter-Strike! Skin, mappe, armi e altro.',
            'parent_slug': 'giochi',
        },
        'nl': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Test je Counter-Strike kennis! Skins, maps, wapens en meer.',
            'parent_slug': 'games',
        },
        'pl': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Sprawd≈∫ swojƒÖ wiedzƒô o Counter-Strike! Sk√≥rki, mapy, bro≈Ñ i wiƒôcej.',
            'parent_slug': 'gry',
        },
        'sv': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Testa din Counter-Strike kunskap! Skins, kartor, vapen och mer.',
            'parent_slug': 'spel',
        },
        'no': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Test din Counter-Strike kunnskap! Skins, kart, v√•pen og mer.',
            'parent_slug': 'spill',
        },
        'id': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Uji pengetahuan Counter-Strike Anda! Skin, map, senjata dan lainnya.',
            'parent_slug': 'game',
        },
        'ja': {
            'title': '„Ç´„Ç¶„É≥„Çø„Éº„Çπ„Éà„É©„Ç§„ÇØ',
            'slug': 'counter-strike',
            'description': 'Counter-Strike„ÅÆÁü•Ë≠ò„Çí„ÉÜ„Çπ„Éà„Åó„Çà„ÅÜÔºÅ„Çπ„Ç≠„É≥„ÄÅ„Éû„ÉÉ„Éó„ÄÅÊ≠¶Âô®„Å™„Å©„ÄÇ',
            'parent_slug': 'gemu',
        },
        'ko': {
            'title': 'Ïπ¥Ïö¥ÌÑ∞ Ïä§Ìä∏ÎùºÏù¥ÌÅ¨',
            'slug': 'counter-strike',
            'description': 'Counter-Strike ÏßÄÏãùÏùÑ ÌÖåÏä§Ìä∏ÌïòÏÑ∏Ïöî! Ïä§ÌÇ®, Îßµ, Î¨¥Í∏∞ Îì±.',
            'parent_slug': 'geim',
        },
        'th': {
            'title': '‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡πÑ‡∏ï‡∏£‡∏Ñ‡πå',
            'slug': 'counter-strike',
            'description': '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ Counter-Strike ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì! ‡∏™‡∏Å‡∏¥‡∏ô ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
            'parent_slug': 'gem',
        },
        'vi': {
            'title': 'Counter-Strike',
            'slug': 'counter-strike',
            'description': 'Ki·ªÉm tra ki·∫øn th·ª©c Counter-Strike c·ªßa b·∫°n! Skin, b·∫£n ƒë·ªì, v≈© kh√≠ v√† h∆°n th·∫ø n·ªØa.',
            'parent_slug': 'tro-choi',
        },
    }

    country_to_lang = {
        'en-US': 'en', 'en-CA': 'en', 'en-GB': 'en', 'en-IN': 'en', 'en-PH': 'en', 'en-AU': 'en', 'en-NZ': 'en',
        'pt-BR': 'pt', 'pt-PT': 'pt',
        'es-MX': 'es', 'es-ES': 'es', 'es-AR': 'es', 'es-CO': 'es',
        'de-DE': 'de',
        'fr-FR': 'fr',
        'it-IT': 'it',
        'nl-NL': 'nl',
        'sv-SE': 'sv',
        'no-NO': 'no',
        'pl-PL': 'pl',
        'id-ID': 'id',
        'ja-JP': 'ja',
        'ko-KR': 'ko',
        'th-TH': 'th',
        'vi-VN': 'vi',
    }

    created_count = 0
    updated_count = 0
    errors = []

    for country_code, lang_code in country_to_lang.items():
        translation = translations.get(lang_code, translations['en'])

        if country_code == 'pt-BR':
            theme_slug = translation['slug']
            parent_slug = translation['parent_slug']
        else:
            country_suffix = country_code.split('-')[1].lower()
            theme_slug = f"{translation['slug']}-{country_suffix}"
            parent_slug = f"{translation['parent_slug']}-{country_suffix}"

        try:
            parent_theme = Theme.objects.get(slug=parent_slug)
        except Theme.DoesNotExist:
            errors.append(f"‚ö†Ô∏è  Tema pai n√£o encontrado: {parent_slug} para {country_code}")
            parent_theme = None

        theme, created = Theme.objects.update_or_create(
            slug=theme_slug,
            defaults={
                'title': translation['title'],
                'description': translation['description'],
                'icon': theme_image,
                'country': country_code,
                'primary_color': colors['primary_color'],
                'secondary_color': colors['secondary_color'],
                'icon_bg_color_1': colors['icon_bg_color_1'],
                'icon_bg_color_2': colors['icon_bg_color_2'],
                'parent': parent_theme,
                'active': True,
                'order': 50,
            }
        )

        if created:
            created_count += 1
            status = "‚úÖ"
        else:
            updated_count += 1
            status = "üîÑ"

        parent_info = f"‚Üí {parent_slug}" if parent_theme else "‚Üí SEM PAI"
        print(f"{status} {country_code:7s} | {theme_slug:25s} {parent_info}")

    print()
    print(f"üìä Temas Counter-Strike criados: {created_count} | Atualizados: {updated_count}")

    if errors:
        print()
        for error in errors:
            print(error)

    print()
    return created_count + updated_count


# ============================================================================
# ETAPA 1: CRIAR TEMAS AK-47
# ============================================================================

def create_ak47_themes():
    """Cria o tema de AK-47 para todos os pa√≠ses"""

    print("=" * 80)
    print("ETAPA 1: CRIANDO TEMAS AK-47")
    print("=" * 80)
    print()

    theme_image = 'https://res.cloudinary.com/dwm53cbu2/image/upload/v1760663546/best-ak-buyers-guide-ak47-feature-hd-768x496_ixmyvw.jpg'

    colors = {
        'primary_color': '#ff6347',  # Vermelho CS:GO
        'secondary_color': '#1e90ff',  # Azul CS:GO
        'icon_bg_color_1': '#fff5f0',
        'icon_bg_color_2': '#ffcccb',
    }

    translations = {
        'pt': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Teste seus conhecimentos sobre as skins da AK-47 do Counter-Strike! Identifique as 55 skins mais ic√¥nicas.',
            'parent_slug': 'counter-strike',
        },
        'en': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Test your knowledge about Counter-Strike AK-47 skins! Identify the 55 most iconic skins.',
            'parent_slug': 'counter-strike',
        },
        'es': {
            'title': 'Skins AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': '¬°Pon a prueba tus conocimientos sobre las skins de AK-47 de Counter-Strike! Identifica las 55 skins m√°s ic√≥nicas.',
            'parent_slug': 'counter-strike',
        },
        'fr': {
            'title': 'Skins AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': 'Testez vos connaissances sur les skins AK-47 de Counter-Strike! Identifiez les 55 skins les plus embl√©matiques.',
            'parent_slug': 'counter-strike',
        },
        'de': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Teste dein Wissen √ºber Counter-Strike AK-47 Skins! Identifiziere die 55 ikonischsten Skins.',
            'parent_slug': 'counter-strike',
        },
        'it': {
            'title': 'Skin AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': 'Metti alla prova le tue conoscenze sulle skin AK-47 di Counter-Strike! Identifica le 55 skin pi√π iconiche.',
            'parent_slug': 'counter-strike',
        },
        'nl': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Test je kennis over Counter-Strike AK-47 skins! Identificeer de 55 meest iconische skins.',
            'parent_slug': 'counter-strike',
        },
        'pl': {
            'title': 'Sk√≥rki AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': 'Sprawd≈∫ swojƒÖ wiedzƒô o sk√≥rkach AK-47 z Counter-Strike! Zidentyfikuj 55 najbardziej kultowych sk√≥rek.',
            'parent_slug': 'counter-strike',
        },
        'sv': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Testa dina kunskaper om Counter-Strike AK-47 skins! Identifiera de 55 mest ikoniska skinsen.',
            'parent_slug': 'counter-strike',
        },
        'no': {
            'title': 'AK-47 Skins - CS2',
            'slug': 'ak47-skins',
            'description': 'Test kunnskapen din om Counter-Strike AK-47 skins! Identifiser de 55 mest ikoniske skinsene.',
            'parent_slug': 'counter-strike',
        },
        'id': {
            'title': 'Skin AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': 'Uji pengetahuan Anda tentang skin AK-47 Counter-Strike! Identifikasi 55 skin paling ikonik.',
            'parent_slug': 'counter-strike',
        },
        'ja': {
            'title': 'AK-47„Çπ„Ç≠„É≥ - CS2',
            'slug': 'ak47-skins',
            'description': 'Counter-Strike„ÅÆAK-47„Çπ„Ç≠„É≥„ÅÆÁü•Ë≠ò„Çí„ÉÜ„Çπ„Éà„Åó„Çà„ÅÜÔºÅ55Á®ÆÈ°û„ÅÆÊúÄ„ÇÇË±°Âæ¥ÁöÑ„Å™„Çπ„Ç≠„É≥„ÇíË≠òÂà•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
            'parent_slug': 'counter-strike',
        },
        'ko': {
            'title': 'AK-47 Ïä§ÌÇ® - CS2',
            'slug': 'ak47-skins',
            'description': 'Counter-Strike AK-47 Ïä§ÌÇ®Ïóê ÎåÄÌïú ÏßÄÏãùÏùÑ ÌÖåÏä§Ìä∏ÌïòÏÑ∏Ïöî! Í∞ÄÏû• ÏÉÅÏßïÏ†ÅÏù∏ 55Í∞úÏùò Ïä§ÌÇ®ÏùÑ ÏãùÎ≥ÑÌïòÏÑ∏Ïöî.',
            'parent_slug': 'counter-strike',
        },
        'th': {
            'title': '‡∏™‡∏Å‡∏¥‡∏ô AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏Å‡∏¥‡∏ô AK-47 ‡∏à‡∏≤‡∏Å Counter-Strike! ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏Å‡∏¥‡∏ô 55 ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î',
            'parent_slug': 'counter-strike',
        },
        'vi': {
            'title': 'Skin AK-47 - CS2',
            'slug': 'ak47-skins',
            'description': 'Ki·ªÉm tra ki·∫øn th·ª©c c·ªßa b·∫°n v·ªÅ skin AK-47 Counter-Strike! X√°c ƒë·ªãnh 55 skin mang t√≠nh bi·ªÉu t∆∞·ª£ng nh·∫•t.',
            'parent_slug': 'counter-strike',
        },
    }

    country_to_lang = {
        'en-US': 'en', 'en-CA': 'en', 'en-GB': 'en', 'en-IN': 'en', 'en-PH': 'en', 'en-AU': 'en', 'en-NZ': 'en',
        'pt-BR': 'pt', 'pt-PT': 'pt',
        'es-MX': 'es', 'es-ES': 'es', 'es-AR': 'es', 'es-CO': 'es',
        'de-DE': 'de',
        'fr-FR': 'fr',
        'it-IT': 'it',
        'nl-NL': 'nl',
        'sv-SE': 'sv',
        'no-NO': 'no',
        'pl-PL': 'pl',
        'id-ID': 'id',
        'ja-JP': 'ja',
        'ko-KR': 'ko',
        'th-TH': 'th',
        'vi-VN': 'vi',
    }

    created_count = 0
    updated_count = 0
    errors = []

    for country_code, lang_code in country_to_lang.items():
        translation = translations.get(lang_code, translations['en'])

        if country_code == 'pt-BR':
            theme_slug = translation['slug']
            parent_slug = translation['parent_slug']
        else:
            country_suffix = country_code.split('-')[1].lower()
            theme_slug = f"{translation['slug']}-{country_suffix}"
            parent_slug = f"{translation['parent_slug']}-{country_suffix}"

        try:
            parent_theme = Theme.objects.get(slug=parent_slug)
        except Theme.DoesNotExist:
            errors.append(f"‚ö†Ô∏è  Tema pai n√£o encontrado: {parent_slug} para {country_code}")
            parent_theme = None

        theme, created = Theme.objects.update_or_create(
            slug=theme_slug,
            defaults={
                'title': translation['title'],
                'description': translation['description'],
                'icon': theme_image,
                'country': country_code,
                'primary_color': colors['primary_color'],
                'secondary_color': colors['secondary_color'],
                'icon_bg_color_1': colors['icon_bg_color_1'],
                'icon_bg_color_2': colors['icon_bg_color_2'],
                'parent': parent_theme,
                'active': True,
                'order': 100,
            }
        )

        if created:
            created_count += 1
            status = "‚úÖ"
        else:
            updated_count += 1
            status = "üîÑ"

        parent_info = f"‚Üí {parent_slug}" if parent_theme else "‚Üí SEM PAI"
        print(f"{status} {country_code:7s} | {theme_slug:25s} {parent_info}")

    print()
    print(f"üìä Temas criados: {created_count} | Atualizados: {updated_count}")

    if errors:
        print()
        for error in errors:
            print(error)

    print()
    return created_count + updated_count


# ============================================================================
# ETAPA 2: CRIAR QUIZGROUP
# ============================================================================

def create_ak47_quizgroup():
    """Cria o QuizGroup para AK-47 Skins"""

    print("=" * 80)
    print("ETAPA 2: CRIANDO QUIZGROUP")
    print("=" * 80)
    print()

    quiz_group, created = QuizGroup.objects.update_or_create(
        slug='ak47-skins-cs2',
        defaults={
            'name': 'AK-47 Skins - Guess the Skin',
            'description': 'Grupo de quizzes "Adivinhe a Skin da AK-47" do CS2, dispon√≠vel em m√∫ltiplos idiomas.',
            'difficulty': 'medium',
            'order': 0,
        }
    )

    status = "‚úÖ Criado" if created else "üîÑ Atualizado"
    print(f"{status}: {quiz_group.name}")
    print()

    return quiz_group


# ============================================================================
# ETAPA 3: CRIAR QUIZZES COM QUEST√ïES
# ============================================================================

def get_quiz_description_template(lang_code):
    """Retorna template de descri√ß√£o com placeholders {sample_size} e {total}"""
    templates = {
        'en': 'Identify {sample_size} random AK-47 skins from the {total} available! Test your Counter-Strike knowledge.',
        'pt': 'Identifique {sample_size} skins aleat√≥rias de AK-47 das {total} dispon√≠veis! Teste seu conhecimento de Counter-Strike.',
        'es': '¬°Identifica {sample_size} skins aleatorias de AK-47 de las {total} disponibles! Pon a prueba tu conocimiento de Counter-Strike.',
        'de': 'Identifizieren Sie {sample_size} zuf√§llige AK-47 Skins aus den {total} verf√ºgbaren! Testen Sie Ihr Counter-Strike Wissen.',
        'fr': 'Identifiez {sample_size} skins AK-47 al√©atoires parmi les {total} disponibles! Testez vos connaissances Counter-Strike.',
        'it': 'Identifica {sample_size} skin AK-47 casuali tra le {total} disponibili! Metti alla prova la tua conoscenza di Counter-Strike.',
        'nl': 'Identificeer {sample_size} willekeurige AK-47 skins uit de {total} beschikbare! Test je Counter-Strike kennis.',
        'sv': 'Identifiera {sample_size} slumpm√§ssiga AK-47 skins fr√•n de {total} tillg√§ngliga! Testa din Counter-Strike kunskap.',
        'no': 'Identifiser {sample_size} tilfeldige AK-47 skins fra de {total} tilgjengelige! Test din Counter-Strike kunnskap.',
        'pl': 'Zidentyfikuj {sample_size} losowych sk√≥rek AK-47 spo≈õr√≥d {total} dostƒôpnych! Przetestuj swojƒÖ wiedzƒô o Counter-Strike.',
        'id': 'Identifikasi {sample_size} skin AK-47 acak dari {total} yang tersedia! Uji pengetahuan Counter-Strike Anda.',
        'ja': '{total}ÂÄã„ÅÆAK-47„Çπ„Ç≠„É≥„Åã„Çâ{sample_size}ÂÄã„Çí„É©„É≥„ÉÄ„É†„Å´Ë≠òÂà•„Åó„Çà„ÅÜÔºÅCounter-Strike„ÅÆÁü•Ë≠ò„Çí„ÉÜ„Çπ„Éà„Åó„Çà„ÅÜ„ÄÇ',
        'ko': '{total}Í∞úÏùò ÏÇ¨Ïö© Í∞ÄÎä•Ìïú AK-47 Ïä§ÌÇ® Ï§ë {sample_size}Í∞úÎ•º Î¨¥ÏûëÏúÑÎ°ú ÏãùÎ≥ÑÌïòÏÑ∏Ïöî! Counter-Strike ÏßÄÏãùÏùÑ ÌÖåÏä§Ìä∏ÌïòÏÑ∏Ïöî.',
        'th': '‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏Å‡∏¥‡∏ô AK-47 {sample_size} ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {total} ‡πÅ‡∏ö‡∏ö! ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ Counter-Strike ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
        'vi': 'Nh·∫≠n d·∫°ng {sample_size} skin AK-47 ng·∫´u nhi√™n t·ª´ {total} skin c√≥ s·∫µn! Ki·ªÉm tra ki·∫øn th·ª©c Counter-Strike c·ªßa b·∫°n.',
    }
    return templates.get(lang_code, templates['en'])


def create_ak47_quizzes(quiz_group, all_skins, cloudinary_urls):
    """Cria os quizzes de AK-47 para todos os pa√≠ses"""

    print("=" * 80)
    print("ETAPA 3: CRIANDO QUIZZES E QUEST√ïES")
    print("=" * 80)
    print()

    country_to_lang = {
        'en-US': 'en', 'en-CA': 'en', 'en-GB': 'en', 'en-IN': 'en', 'en-PH': 'en', 'en-AU': 'en', 'en-NZ': 'en',
        'pt-BR': 'pt', 'pt-PT': 'pt',
        'es-MX': 'es', 'es-ES': 'es', 'es-AR': 'es', 'es-CO': 'es',
        'de-DE': 'de',
        'fr-FR': 'fr',
        'it-IT': 'it',
        'nl-NL': 'nl',
        'sv-SE': 'sv',
        'no-NO': 'no',
        'pl-PL': 'pl',
        'id-ID': 'id',
        'ja-JP': 'ja',
        'ko-KR': 'ko',
        'th-TH': 'th',
        'vi-VN': 'vi',
    }

    quiz_translations = {
        'en': {
            'title': 'Guess the AK-47 Skin - CS2',
            'question_text': 'Which AK-47 skin is this?',
            'explanation_template': 'This is {name}, an AK-47 skin from Counter-Strike 2.'
        },
        'pt': {
            'title': 'Adivinhe a Skin da AK-47 - CS2',
            'question_text': 'Qual √© esta skin de AK-47?',
            'explanation_template': 'Esta √© {name}, uma skin de AK-47 do Counter-Strike 2.'
        },
        'es': {
            'title': 'Adivina la Skin de AK-47 - CS2',
            'question_text': '¬øCu√°l es esta skin de AK-47?',
            'explanation_template': 'Esta es {name}, una skin de AK-47 de Counter-Strike 2.'
        },
        'de': {
            'title': 'Errate die AK-47 Skin - CS2',
            'question_text': 'Welche AK-47 Skin ist das?',
            'explanation_template': 'Dies ist {name}, eine AK-47 Skin aus Counter-Strike 2.'
        },
        'fr': {
            'title': 'Devinez la Skin AK-47 - CS2',
            'question_text': 'Quelle est cette skin AK-47?',
            'explanation_template': 'C\'est {name}, une skin AK-47 de Counter-Strike 2.'
        },
        'it': {
            'title': 'Indovina la Skin AK-47 - CS2',
            'question_text': 'Quale skin AK-47 √® questa?',
            'explanation_template': 'Questa √® {name}, una skin AK-47 di Counter-Strike 2.'
        },
        'nl': {
            'title': 'Raad de AK-47 Skin - CS2',
            'question_text': 'Welke AK-47 skin is dit?',
            'explanation_template': 'Dit is {name}, een AK-47 skin van Counter-Strike 2.'
        },
        'sv': {
            'title': 'Gissa AK-47 Skinnet - CS2',
            'question_text': 'Vilket AK-47 skin √§r detta?',
            'explanation_template': 'Detta √§r {name}, en AK-47 skin fr√•n Counter-Strike 2.'
        },
        'no': {
            'title': 'Gjett AK-47 Skinnet - CS2',
            'question_text': 'Hvilket AK-47 skin er dette?',
            'explanation_template': 'Dette er {name}, en AK-47 skin fra Counter-Strike 2.'
        },
        'pl': {
            'title': 'Zgadnij Sk√≥rkƒô AK-47 - CS2',
            'question_text': 'Kt√≥ra to sk√≥rka AK-47?',
            'explanation_template': 'To jest {name}, sk√≥rka AK-47 z Counter-Strike 2.'
        },
        'id': {
            'title': 'Tebak Skin AK-47 - CS2',
            'question_text': 'Skin AK-47 apa ini?',
            'explanation_template': 'Ini adalah {name}, skin AK-47 dari Counter-Strike 2.'
        },
        'ja': {
            'title': 'AK-47„Çπ„Ç≠„É≥„ÇíÂΩì„Å¶„Çà„ÅÜ - CS2',
            'question_text': '„Åì„ÅÆAK-47„Çπ„Ç≠„É≥„ÅØ‰ΩïÔºü',
            'explanation_template': '„Åì„Çå„ÅØ{name}„ÄÅCounter-Strike 2„ÅÆAK-47„Çπ„Ç≠„É≥„Åß„Åô„ÄÇ'
        },
        'ko': {
            'title': 'AK-47 Ïä§ÌÇ® ÎßûÌûàÍ∏∞ - CS2',
            'question_text': 'Ïù¥ AK-47 Ïä§ÌÇ®ÏùÄ Î¨¥ÏóáÏûÖÎãàÍπå?',
            'explanation_template': 'Ïù¥Í≤ÉÏùÄ {name}, Counter-Strike 2Ïùò AK-47 Ïä§ÌÇ®ÏûÖÎãàÎã§.'
        },
        'th': {
            'title': '‡∏ó‡∏≤‡∏¢‡∏™‡∏Å‡∏¥‡∏ô AK-47 - CS2',
            'question_text': '‡∏™‡∏Å‡∏¥‡∏ô AK-47 ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?',
            'explanation_template': '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ {name} ‡∏™‡∏Å‡∏¥‡∏ô AK-47 ‡∏à‡∏≤‡∏Å Counter-Strike 2'
        },
        'vi': {
            'title': 'ƒêo√°n Skin AK-47 - CS2',
            'question_text': 'ƒê√¢y l√† skin AK-47 n√†o?',
            'explanation_template': 'ƒê√¢y l√† {name}, m·ªôt skin AK-47 t·ª´ Counter-Strike 2.'
        },
    }

    countries = list(country_to_lang.keys())
    num_questions = len(all_skins)  # 55 skins
    created_count = 0
    updated_count = 0
    total_questions_created = 0

    for country_code in countries:
        lang_code = country_to_lang[country_code]
        translation = quiz_translations.get(lang_code, quiz_translations['en'])

        # Determinar slug do tema
        if country_code == 'pt-BR':
            theme_slug = 'ak47-skins'
        else:
            country_suffix = country_code.split('-')[1].lower()
            theme_slug = f"ak47-skins-{country_suffix}"

        # Buscar tema
        try:
            theme = Theme.objects.get(slug=theme_slug)
        except Theme.DoesNotExist:
            print(f"‚ö†Ô∏è  Tema n√£o encontrado: {theme_slug}")
            continue

        # Determinar slug do quiz
        quiz_base_slug = 'adivinhe-skin-ak47' if lang_code == 'pt' else 'guess-ak47-skin'
        if country_code == 'pt-BR':
            quiz_slug = quiz_base_slug
        else:
            country_suffix = country_code.split('-')[1].lower()
            quiz_slug = f"{quiz_base_slug}-{country_suffix}"

        # Gerar template e description inicial
        quiz_sample_size = num_questions
        quiz_description_template = get_quiz_description_template(lang_code)
        quiz_description = quiz_description_template.format(sample_size=num_questions, total=num_questions)

        # Criar ou atualizar quiz
        quiz, quiz_created = Quiz.objects.update_or_create(
            slug=quiz_slug,
            defaults={
                'theme': theme,
                'quiz_group': quiz_group,
                'title': translation['title'],
                'description': quiz_description,
                'description_template': quiz_description_template,
                'difficulty': 'medium',
                'active': True,
                'order': 1,
                'country': country_code,
                'question_sample_size': quiz_sample_size,
            }
        )

        if quiz_created:
            created_count += 1
            status = "‚úÖ"
        else:
            updated_count += 1
            status = "üîÑ"
            # Limpar quest√µes antigas
            quiz.questions.all().delete()

        print(f"{status} {country_code} | {quiz_slug}")

        # Criar quest√µes
        question_count = 0

        for idx, skin in enumerate(all_skins, 1):
            name = skin['name']

            explanation = translation['explanation_template'].format(name=name)

            # Determinar imagem
            image_path = get_skin_url(name, cloudinary_urls, skin['foto'])

            # Criar quest√£o
            question = Question.objects.create(
                quiz=quiz,
                text=translation['question_text'],
                image=image_path,
                explanation=explanation,
                order=idx
            )

            # Criar respostas (correta + 3 incorretas das op√ß√µes)
            answers_data = [{'text': name, 'is_correct': True}]
            for wrong_option in skin['opcoes'][:3]:  # Pegar as 3 op√ß√µes incorretas
                answers_data.append({'text': wrong_option, 'is_correct': False})

            random.shuffle(answers_data)

            for answer_data in answers_data:
                Answer.objects.create(
                    question=question,
                    text=answer_data['text'],
                    is_correct=answer_data['is_correct']
                )

            question_count += 1

        total_questions_created += question_count
        print(f"   ‚ùì {question_count} quest√µes criadas")

    print()
    print(f"üìä Quizzes criados: {created_count} | Atualizados: {updated_count}")
    print(f"‚ùì Total de quest√µes: {total_questions_created}")

    # Atualizar descri√ß√µes ap√≥s criar todas as quest√µes
    print("\nüîÑ Atualizando descri√ß√µes dos quizzes...")
    updated_descriptions = 0
    for country_code in countries:
        lang_code = country_to_lang[country_code]

        # Determinar slug do quiz
        quiz_base_slug = 'adivinhe-skin-ak47' if lang_code == 'pt' else 'guess-ak47-skin'
        if country_code == 'pt-BR':
            quiz_slug = quiz_base_slug
        else:
            country_suffix = country_code.split('-')[1].lower()
            quiz_slug = f"{quiz_base_slug}-{country_suffix}"

        try:
            quiz = Quiz.objects.get(slug=quiz_slug)
            if quiz.description_template:
                quiz.save()  # Isso vai chamar render_description() automaticamente
                updated_descriptions += 1
        except Quiz.DoesNotExist:
            pass

    print(f"‚úÖ {updated_descriptions} descri√ß√µes atualizadas")
    print()

    return created_count, updated_count


# ============================================================================
# ETAPA 4: CRIAR BADGES
# ============================================================================

def create_ak47_badges(quiz_group):
    """Cria as badges de AK-47 Skins e associa ao QuizGroup"""

    print("=" * 80)
    print("ETAPA 4: CRIANDO BADGES DE AK-47 SKINS")
    print("=" * 80)
    print()

    # Tradu√ß√µes das descri√ß√µes das badges
    badge_descriptions = {
        'bronze': {
            'pt-BR': 'Acerte todas as skins de AK-47!',
            'en-US': 'Get all AK-47 skins correct!',
            'en-CA': 'Get all AK-47 skins correct!',
            'en-GB': 'Get all AK-47 skins correct!',
            'en-IN': 'Get all AK-47 skins correct!',
            'en-PH': 'Get all AK-47 skins correct!',
            'en-AU': 'Get all AK-47 skins correct!',
            'en-NZ': 'Get all AK-47 skins correct!',
            'pt-PT': 'Acerta todas as skins de AK-47!',
            'es-MX': '¬°Acierta todas las skins de AK-47!',
            'es-ES': '¬°Acierta todas las skins de AK-47!',
            'es-AR': '¬°Acierta todas las skins de AK-47!',
            'es-CO': '¬°Acierta todas las skins de AK-47!',
            'de-DE': 'Errate alle AK-47 Skins!',
            'fr-FR': 'Trouvez toutes les skins AK-47!',
            'it-IT': 'Indovina tutte le skin AK-47!',
            'nl-NL': 'Raad alle AK-47 skins!',
            'sv-SE': 'Gissa alla AK-47 skins!',
            'no-NO': 'Gjett alle AK-47 skins!',
            'pl-PL': 'Zgadnij wszystkie sk√≥rki AK-47!',
            'id-ID': 'Tebak semua skin AK-47!',
            'ja-JP': '„Åô„Åπ„Å¶„ÅÆAK-47„Çπ„Ç≠„É≥„ÇíÂΩì„Å¶„Çà„ÅÜÔºÅ',
            'ko-KR': 'Î™®Îì† AK-47 Ïä§ÌÇ®ÏùÑ ÎßûÌûàÏÑ∏Ïöî!',
            'th-TH': '‡∏ó‡∏≤‡∏¢‡∏™‡∏Å‡∏¥‡∏ô AK-47 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!',
            'vi-VN': 'ƒêo√°n ƒë√∫ng t·∫•t c·∫£ skin AK-47!',
        },
        'silver': {
            'pt-BR': 'Acerte todas as skins em menos de 15 minutos!',
            'en-US': 'Get all skins correct in under 15 minutes!',
            'en-CA': 'Get all skins correct in under 15 minutes!',
            'en-GB': 'Get all skins correct in under 15 minutes!',
            'en-IN': 'Get all skins correct in under 15 minutes!',
            'en-PH': 'Get all skins correct in under 15 minutes!',
            'en-AU': 'Get all skins correct in under 15 minutes!',
            'en-NZ': 'Get all skins correct in under 15 minutes!',
            'pt-PT': 'Acerta todas as skins em menos de 15 minutos!',
            'es-MX': '¬°Acierta todas las skins en menos de 15 minutos!',
            'es-ES': '¬°Acierta todas las skins en menos de 15 minutos!',
            'es-AR': '¬°Acierta todas las skins en menos de 15 minutos!',
            'es-CO': '¬°Acierta todas las skins en menos de 15 minutos!',
            'de-DE': 'Errate alle Skins in unter 15 Minuten!',
            'fr-FR': 'Trouvez toutes les skins en moins de 15 minutes!',
            'it-IT': 'Indovina tutte le skin in meno di 15 minuti!',
            'nl-NL': 'Raad alle skins in minder dan 15 minuten!',
            'sv-SE': 'Gissa alla skins p√• under 15 minuter!',
            'no-NO': 'Gjett alle skins p√• under 15 minutter!',
            'pl-PL': 'Zgadnij wszystkie sk√≥rki w mniej ni≈º 15 minut!',
            'id-ID': 'Tebak semua skin dalam waktu kurang dari 15 menit!',
            'ja-JP': '15ÂàÜ‰ª•ÂÜÖ„Å´„Åô„Åπ„Å¶„ÅÆ„Çπ„Ç≠„É≥„ÇíÂΩì„Å¶„Çà„ÅÜÔºÅ',
            'ko-KR': '15Î∂Ñ Ïù¥ÎÇ¥Ïóê Î™®Îì† Ïä§ÌÇ®ÏùÑ ÎßûÌûàÏÑ∏Ïöî!',
            'th-TH': '‡∏ó‡∏≤‡∏¢‡∏™‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ!',
            'vi-VN': 'ƒêo√°n ƒë√∫ng t·∫•t c·∫£ skin trong v√≤ng 15 ph√∫t!',
        },
        'gold': {
            'pt-BR': 'Acerte todas as skins em menos de 8 minutos!',
            'en-US': 'Get all skins correct in under 8 minutes!',
            'en-CA': 'Get all skins correct in under 8 minutes!',
            'en-GB': 'Get all skins correct in under 8 minutes!',
            'en-IN': 'Get all skins correct in under 8 minutes!',
            'en-PH': 'Get all skins correct in under 8 minutes!',
            'en-AU': 'Get all skins correct in under 8 minutes!',
            'en-NZ': 'Get all skins correct in under 8 minutes!',
            'pt-PT': 'Acerta todas as skins em menos de 8 minutos!',
            'es-MX': '¬°Acierta todas las skins en menos de 8 minutos!',
            'es-ES': '¬°Acierta todas las skins en menos de 8 minutos!',
            'es-AR': '¬°Acierta todas las skins en menos de 8 minutos!',
            'es-CO': '¬°Acierta todas las skins en menos de 8 minutos!',
            'de-DE': 'Errate alle Skins in unter 8 Minuten!',
            'fr-FR': 'Trouvez toutes les skins en moins de 8 minutes!',
            'it-IT': 'Indovina tutte le skin in meno di 8 minuti!',
            'nl-NL': 'Raad alle skins in minder dan 8 minuten!',
            'sv-SE': 'Gissa alla skins p√• under 8 minuter!',
            'no-NO': 'Gjett alle skins p√• under 8 minutter!',
            'pl-PL': 'Zgadnij wszystkie sk√≥rki w mniej ni≈º 8 minut!',
            'id-ID': 'Tebak semua skin dalam waktu kurang dari 8 menit!',
            'ja-JP': '8ÂàÜ‰ª•ÂÜÖ„Å´„Åô„Åπ„Å¶„ÅÆ„Çπ„Ç≠„É≥„ÇíÂΩì„Å¶„Çà„ÅÜÔºÅ',
            'ko-KR': '8Î∂Ñ Ïù¥ÎÇ¥Ïóê Î™®Îì† Ïä§ÌÇ®ÏùÑ ÎßûÌûàÏÑ∏Ïöî!',
            'th-TH': '‡∏ó‡∏≤‡∏¢‡∏™‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 8 ‡∏ô‡∏≤‡∏ó‡∏µ!',
            'vi-VN': 'ƒêo√°n ƒë√∫ng t·∫•t c·∫£ skin trong v√≤ng 8 ph√∫t!',
        },
    }

    badges_data = [
        {
            'title': 'ü•â Bronze AK Master',
            'description': 'Acerte todas as skins de AK-47!',
            'description_translations': badge_descriptions['bronze'],
            'image': 'https://res.cloudinary.com/dwm53cbu2/image/upload/v1760663642/ChatGPT_Image_Oct_16_2025_07_47_54_PM_n8e3ff.png',
            'rule_type': 'perfect_score',
            'min_percentage': 100.0,
            'max_time_seconds': None,
            'rarity': 'rare',
            'points': 100,
            'order': 1,
        },
        {
            'title': 'ü•à Silver Elite AK',
            'description': 'Acerte todas as skins em menos de 15 minutos!',
            'description_translations': badge_descriptions['silver'],
            'image': 'https://res.cloudinary.com/dwm53cbu2/image/upload/v1760663641/ChatGPT_Image_Oct_16_2025_06_21_46_PM_pzs3sz.png',
            'rule_type': 'percentage_time',
            'min_percentage': 100.0,
            'max_time_seconds': 900,  # 15 minutos
            'rarity': 'epic',
            'points': 200,
            'order': 2,
        },
        {
            'title': 'ü•á Gold Nova AK',
            'description': 'Acerte todas as skins em menos de 8 minutos!',
            'description_translations': badge_descriptions['gold'],
            'image': 'https://res.cloudinary.com/dwm53cbu2/image/upload/v1760663641/ChatGPT_Image_Oct_16_2025_06_21_49_PM_pdwnmr.png',
            'rule_type': 'percentage_time',
            'min_percentage': 100.0,
            'max_time_seconds': 480,  # 8 minutos
            'rarity': 'legendary',
            'points': 300,
            'order': 3,
        },
    ]

    created_count = 0
    updated_count = 0
    associated_count = 0

    for badge_data in badges_data:
        # Criar ou atualizar badge
        badge, created = Badge.objects.update_or_create(
            title=badge_data['title'],
            defaults={
                'description': badge_data['description'],
                'description_translations': badge_data['description_translations'],
                'image': badge_data['image'],
                'rule_type': badge_data['rule_type'],
                'min_percentage': badge_data['min_percentage'],
                'max_time_seconds': badge_data['max_time_seconds'],
                'rarity': badge_data['rarity'],
                'points': badge_data['points'],
                'order': badge_data['order'],
                'active': True,
            }
        )

        if created:
            created_count += 1
            status = "‚úÖ CRIADO"
        else:
            updated_count += 1
            status = "üîÑ ATUALIZADO"

        # Associar ao QuizGroup
        group_badge, group_created = QuizGroupBadge.objects.get_or_create(
            quiz_group=quiz_group,
            badge=badge,
            defaults={'active': True}
        )

        if group_created:
            associated_count += 1
            association_status = "üîó Associado"
        else:
            association_status = "‚úì J√° associado"

        time_info = ""
        if badge_data['max_time_seconds']:
            minutes = badge_data['max_time_seconds'] // 60
            time_info = f" (< {minutes}min)"

        print(f"{status:15s} | {badge_data['title']:25s} | {badge_data['rarity']:10s} | {badge_data['points']:3d} pts{time_info:15s} | {association_status}")

    print()
    print(f"üìä Badges criadas: {created_count} | Atualizadas: {updated_count} | Associadas: {associated_count}")
    print()

    return created_count, updated_count


# ============================================================================
# MAIN
# ============================================================================

def main():
    print()
    print("=" * 80)
    print("üéÆ SETUP COMPLETO: AK-47 SKINS - COUNTER-STRIKE 2")
    print("=" * 80)
    print()

    # Carregar dados
    print("üìÇ Carregando dados das skins AK-47...")
    all_skins = load_ak47_data()
    if not all_skins:
        return

    cloudinary_urls = load_cloudinary_urls()
    if cloudinary_urls:
        print(f"‚úÖ {len(cloudinary_urls)} URLs do Cloudinary carregadas")
    else:
        print("‚ö†Ô∏è  Usando URLs do JSON original")

    print(f"‚úÖ {len(all_skins)} skins de AK-47 carregadas")
    print()

    # Etapa 0: Criar temas Counter-Strike (pai)
    cs_themes_count = create_counter_strike_themes()

    # Etapa 1: Criar temas AK-47
    themes_count = create_ak47_themes()

    # Etapa 2: Criar QuizGroup
    quiz_group = create_ak47_quizgroup()

    # Etapa 3: Criar Quizzes e Quest√µes
    quizzes_created, quizzes_updated = create_ak47_quizzes(quiz_group, all_skins, cloudinary_urls)

    # Etapa 4: Criar Badges
    badges_created, badges_updated = create_ak47_badges(quiz_group)

    # Resumo final
    print("=" * 80)
    print("üìä RESUMO FINAL")
    print("=" * 80)
    print(f"‚úÖ Temas Counter-Strike (pai): {cs_themes_count}")
    print(f"‚úÖ Temas AK-47: {themes_count}")
    print(f"‚úÖ QuizGroup: 1")
    print(f"‚úÖ Quizzes criados: {quizzes_created}")
    print(f"üîÑ Quizzes atualizados: {quizzes_updated}")
    print(f"üìù Total de quizzes no grupo: {quiz_group.quizzes.count()}")
    print(f"üèÜ Badges criadas: {badges_created}")
    print(f"üîÑ Badges atualizadas: {badges_updated}")
    print()
    print("üéâ Setup completo de AK-47 Skins conclu√≠do com sucesso!")
    print()
    print("üí° Pr√≥ximos passos:")
    print("   1. Verifique os temas em /admin/quizzes/theme/")
    print("   2. Verifique as badges em /admin/quizzes/badge/")
    print("   3. Acesse um quiz para testar: /quiz/adivinhe-skin-ak47/")
    print("   4. Complete um quiz para testar se as badges s√£o concedidas automaticamente!")
    print()


if __name__ == '__main__':
    main()
